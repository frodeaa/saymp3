#!/usr/bin/env bash

# This script use the OSX say command to convert input text to mp3
# The script requires lame and mp3val to be installed
#
#  $ brew install lame mp3val
#
# Example:
#
#  $ cat book.txt | saymp3 -v alex -r 200 -o book.mp3

me="$(basename "$(test -L "$0" && readlink "$0" || echo "$0")")"

function usage {
	cat <<EOF
usage: ${me} [-v voice] [-r rate] [-V quality] [-o output] [file...]

options:
  -v, -v=alex        specify the voice to be used.
  -r, -r=200         speech rate to be used, in words per minute.
  -V, -V=4           quality settings for VBR, 0=highest, 9=smaller file
  -o, o=out.mp3      output filename
  -p                 show progress
  -h                 show help
EOF
	exit 1
}

function progress {
	local spin='-\|/'
	echo -ne "${spin:$1:1} encode line $2\r"
}

set -e

show_progress=false
voice="alex"
rate="200"
quality="4"
filename="out.mp3"

while getopts "hpv:r:V:o:" opt; do
	case ${opt} in
		h)
			usage
			;;
		v)
			voice=${OPTARG}
			;;
		r)
			rate=${OPTARG}
			;;
		V)
			quality=${OPTARG}
			;;
		o)
			filename=${OPTARG}
			;;
		p)
			show_progress=true
			;;
		:)
			echo "option -$OPTARG requires an argument." >&2
			exit 1
		;;
	esac
done

shift $(( OPTIND-1 ))

tmp_dir=`mktemp -d 2>/dev/null || mktemp -d -t "${me}"`
trap 'rm -rf "${tmp_dir}"' EXIT

k=0
i=0
while read line;
do
	[ -z "$line" ] && continue
	if $show_progress ; then i=$(( (i+1) %4 )) && progress $i $k; fi
	tmp_out="${tmp_dir}/${k}.aiff"
	say -v "${voice}" -r "${rate}" -o "${tmp_out}" ${line}
	lame --quiet -q 0 -v -V "${quality}" "${tmp_out}" "${tmp_out}.mp3"
	rm "${tmp_out}"
	k=$((k + 1))
done < "${1:-/dev/stdin}"

rm "${filename}"
find "${tmp_dir}" -name "*.mp3" | sort | xargs cat >> "${filename}"
mp3val "${filename}" -f -nb > /dev/null 2>&1

exit 1

